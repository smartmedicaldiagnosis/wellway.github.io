<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WellWay Navigator</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="assets/icons/compass.svg">
</head>
<body>
  <header class="header">
    <img src="assets/icons/logo-wellway.svg" alt="WellWay" class="logo">
    <h1>–ú–∞—Ä—à—Ä—É—Ç –∑–¥–æ—Ä–æ–≤—å—è</h1>
  </header>

  <main class="container" id="app">
    <!-- –®–∞–≥ 1: –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ -->
    <div id="step-choose" class="step">
      <p class="prompt">–ö–∞–∫ –Ω–∞–π—Ç–∏ –∫–∞–±–∏–Ω–µ—Ç?</p>
      <button class="btn btn-primary" onclick="showStep('by-number')">–Ø –∑–Ω–∞—é –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞</button>
      <button class="btn btn-secondary" onclick="showStep('by-specialty')">–Ø –∏—â—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</button>
      <button class="btn btn-help" onclick="navigateTo('help')">–ü–æ–º–æ—â—å ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞</button>
    </div>

    <!-- –®–∞–≥ 2a: –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ -->
    <div id="step-by-number" class="step hidden">
      <label for="room-input">–ù–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞:</label>
      <input type="text" id="room-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 314" autocomplete="off">
      <div class="btn-group">
        <button class="btn" onclick="showStep('choose')">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn btn-primary" onclick="searchByNumber()">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="room-suggestions" class="suggestions hidden"></div>
    </div>

    <!-- –®–∞–≥ 2b: –≤—ã–±–æ—Ä —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
    <div id="step-by-specialty" class="step hidden">
      <p class="prompt">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</p>
      <div id="specialties-list"></div>
      <button class="btn" onclick="showStep('choose')">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –º–∞—Ä—à—Ä—É—Ç -->
    <div id="step-result" class="step hidden">
      <h2 id="result-title">–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω</h2>
      <div id="route-instructions"></div>
      <div id="route-map" class="map-placeholder">üó∫Ô∏è –ö–∞—Ä—Ç–∞ (SVG –±—É–¥–µ—Ç –∑–¥–µ—Å—å)</div>
      <button class="btn btn-primary" onclick="reset()">–ù–æ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
    </div>
  </main>

  <script src="lib/core.js"></script>
  <script>
    let config = null;

    async function loadConfig() {
      const res = await fetch('config.json');
      config = await res.json();
    }

    async function init() {
      await loadConfig();
      renderSpecialties();
      // –ï—Å–ª–∏ URL —Å–æ–¥–µ—Ä–∂–∏—Ç ?from=node_X ‚Üí –Ω–∞—á–∞—Ç—å —Å —Ç–æ—á–∫–∏ X (–¥–ª—è QR)
      const urlParams = new URLSearchParams(window.location.search);
      const fromNode = urlParams.get('from');
      if (fromNode) {
        // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ future Dijkstra
        console.log("–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞:", fromNode);
      }
    }

    function renderSpecialties() {
      const list = document.getElementById('specialties-list');
      list.innerHTML = '';
      config.specialties.forEach(spec => {
        const btn = document.createElement('button');
        btn.className = 'btn specialty-btn';
        btn.textContent = spec.name;
        btn.onclick = () => selectSpecialty(spec);
        list.appendChild(btn);
      });
    }

    function selectSpecialty(spec) {
      if (spec.rooms.length === 1) {
        buildRoute(spec.rooms[0]);
      } else {
        // TODO: –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö
        alert(`–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–±–∏–Ω–µ—Ç:\n${spec.rooms.map(r => `${r.name} ‚Äî –∫–∞–±. ${r.number}`).join('\n')}`);
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —à–∞–≥ —Å radiobutton'–∞–º–∏
        buildRoute(spec.rooms[0]); // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–≤—ã–π
      }
    }

    function searchByNumber() {
      const num = document.getElementById('room-input').value.trim();
      if (!num) return;
      // –ù–∞–π—Ç–∏ –∫–∞–±–∏–Ω–µ—Ç –ø–æ –Ω–æ–º–µ—Ä—É (–ø—Ä–æ—Å—Ç–æ–π –ª–∏–Ω–µ–π–Ω—ã–π –ø–æ–∏—Å–∫)
      for (const spec of config.specialties) {
        const room = spec.rooms.find(r => r.number === num);
        if (room) {
          buildRoute(room);
          return;
        }
      }
      alert(`–ö–∞–±–∏–Ω–µ—Ç ${num} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä.`);
    }

    function buildRoute(room) {
      document.getElementById('result-title').textContent = `‚Üí –ö–∞–±–∏–Ω–µ—Ç ${room.number}`;
      const instructions = document.getElementById('route-instructions');
      instructions.innerHTML = `
        <ol>
          <li>–ò–¥–∏—Ç–µ –∫ –ª–∏—Ñ—Ç—É</li>
          <li>–ü–æ–¥–Ω–∏–º–∏—Ç–µ—Å—å –Ω–∞ ${room.floor} —ç—Ç–∞–∂</li>
          <li>–ü—Ä–æ–π–¥–∏—Ç–µ –≤ ${room.name || '–Ω—É–∂–Ω–æ–µ –∫—Ä—ã–ª–æ'}</li>
          <li>–ö–∞–±–∏–Ω–µ—Ç ${room.number} ‚Äî –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –≤–∞–º–∏</li>
        </ol>
      `;
      showStep('result');
    }

    function navigateTo(target) {
      if (target === 'help') {
        alert("–ú–∞—Ä—à—Ä—É—Ç –¥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã: –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ –æ—Ç –≤—Ö–æ–¥–∞, –∫–∞–±–∏–Ω–µ—Ç 101.");
        // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å buildRoute() –¥–ª—è "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã", –µ—Å–ª–∏ –æ–Ω–∞ –≤ config
      }
    }

    function showStep(id) {
      document.querySelectorAll('.step').forEach(el => el.classList.add('hidden'));
      document.getElementById(`step-${id}`).classList.remove('hidden');
    }

    function reset() {
      showStep('choose');
      document.getElementById('room-input').value = '';
      document.getElementById('room-suggestions').classList.add('hidden');
    }

    window.onload = init;
  </script>
</body>
</html>
